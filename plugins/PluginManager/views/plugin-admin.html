<div id="repository">
    <div class="plugin-manager">
        <div class="row">
            <div class="span1">
                <div class="btn-group">
                    <button class="btn btn-inverse"><i class="icon-wrench icon-white"></i></button>
                    <button class="btn btn-inverse dropdown-toggle" data-toggle="dropdown">
                        <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <a id="repo-refresh" href="{{updaterepo}}">
                                <i class="icon-retweet icon-white"></i> {{#i}}Update Repository{{/i}}
                            </a>
                        </li>
                        <li>
                            <a href="{{updateplugins}}">
                                <i class="icon-globe icon-white"></i> {{#i}}Search Plugin Updates{{/i}}
                            </a>
                        </li>
                        <li>
                            <a href="{{updatelocal}}" data-via-ajax="page">
                                <i class="icon-refresh icon-white"></i> {{#i}}Refresh Local Plugins{{/i}}
                            </a>
                        </li>
                        <li>
                            <a id="menu-refresh" href="{{updatemenus}}">
                                <i class="icon-list-alt icon-white"></i> {{#i}}Refresh Menus{{/i}}
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="span5">
                <form>
                    <div class="input-append">
                        <input id="plugin-search" type="search" name="search_field">
                        <span class="add-on"><i class="icon-search"></i></span>
                    </div>
                </form>
            </div>
            <div class="span3">
            </div>
            <div class="span3"></div>
        </div>
    </div>
    <div class="plugin-repo">
        {{#RESULTS}}
        <div class="row old-bind">
            <div class="column span1">
                {{#installed}}
                <span class="label label-success">{{#i}}ready{{/i}}</span>
                {{/installed}}

                {{^installed}}
                    {{#repo}}
                <span class="label label-info">{{#i}}repo{{/i}}</span>
                    {{/repo}}
                {{/installed}}

                {{^installed}}
                    {{#local}}
                <span class="label label-inverse">{{#i}}local{{/i}}</span>
                    {{/local}}
                {{/installed}}

                {{#broken}}
                <span class="label label-important">{{#i}}broken{{/i}}</span>
                {{/broken}}
            </div>
            <div class="column span5">
                {{#installed}}
                <div class="plugin-name text-success">{{name}}</div>
                {{/installed}}

                {{^installed}}
                    {{^local}}
                        {{#repo}}
                <div class="plugin-name text-info">{{name}}</div>
                        {{/repo}}
                    {{/local}}
                {{/installed}}

                {{^installed}}
                    {{#local}}
                        {{^broken}}
                <div class="plugin-name">{{name}}</div>
                        {{/broken}}
                        {{#broken}}
                <div class="plugin-name text-error">{{name}}</div>
                        {{/broken}}
                    {{/local}}
                {{/installed}}

                <div class="plugin-short-description muted">{{desc}}</div>
            </div>
            <div class="column span3">
                <div class="hide">
                    {{#installed}}
                    <button data-plugin="{{name}}" class="plugin-get-info btn btn-info"><i class="icon-info-sign icon-white"></i></button>
                    <button class="btn btn-inverse"><i class="icon-repeat icon-white"></i></button>
                    <button class="btn btn"><i class="icon-off"></i></button>
                    {{/installed}}

                    {{^installed}}
                        {{^broken}}
                    <button data-plugin="{{name}}" class="plugin-get-info btn btn-info"><i class="icon-info-sign icon-white"></i></button>
                    <button class="btn btn-inverse"><i class="icon-download-alt icon-white"></i></button>
                            {{#local}}
                    <button class="btn btn-warning"><i class="icon-trash icon-white"></i></button>
                            {{/local}}
                        {{/broken}}
                    {{/installed}}

                    {{#broken}}
                    <button class="btn btn-warning"><i class="icon-trash icon-white"></i></button>
                    {{/broken}}
                </div>
            </div>
            <div class="column span3">
                {{#cfgerror}}
                <div class="alert alert-error">{{#i}}<strong>add xml config here:</strong> {{/i}}{{cfgerror}}</div>
                {{/cfgerror}}
            </div>
        </div>
        {{/RESULTS}}
    </div>
    <div id="new-plugin-template" class="hide">
        <div class="row new-bind">
            <div class="column span1">
                <span class="label label-info">{{#i}}repo{{/i}}</span>
                <span class="label label-warning">{{#i}}new{{/i}}</span>
            </div>
            <div class="column span5">
                <div class="plugin-name text-warning"></div>
                <div class="plugin-short-description muted"></div>
            </div>
            <div class="column span3">
                <div class="hide">
                    <button class="btn btn-info"><i class="icon-info-sign icon-white"></i></button>
                    <button class="btn btn-inverse"><i class="icon-download-alt icon-white"></i></button>
                </div>
            </div>
            <div class="column span3"></div>
        </div>
    </div>
    <!-- Modal -->
    <div id="plugin-info" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="plugin-modal-label" aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h3 id="plugin-modal-label">Modal header</h3>
            <div id="config-description" class="muted"></div>
        </div>
        <div class="modal-body">
            <dl class="dl-horizontal">
                <dt>{{#i}}Recource Author{{/i}}</dt>
                <dd id="config-founder"></dd>
                <dt>{{#i}}Plugin Author{{/i}}</dt>
                <dd id="config-author"></dd>
                <dt>{{#i}}Plugin Author Email{{/i}}</dt>
                <dd id="config-email"></dd>
                <dt>{{#i}}Plugin Homepage{{/i}}</dt>
                <dd id="config-homepage"></dd>
                <dt>{{#i}}Date Released{{/i}}</dt>
                <dd id="config-date"></dd>
                <dt>{{#i}}Copyright{{/i}}</dt>
                <dd id="config-copyright"></dd>
                <dt>{{#i}}License{{/i}}</dt>
                <dd id="config-license"></dd>
            </dl>
            <hr>
            <div id="config-info"></div>
        </div>
        <div class="modal-footer">
            <button class="btn" data-dismiss="modal" aria-hidden="true">{{#i}}Close{{/i}}</button>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function () {
        $("#plugin-search").searchFilter("div.plugin-repo div.row");

        $(this).on('pluginsUpdated', function (event) {
            bindNewPluginButtins(".new-bind");
        });
        bindNewPluginButtins(".old-bind");
        // Repository update.
        $("#repo-refresh").on("click", function() {
            requestPage();
            var url = $(this).attr("href");
            $.get(url, function (data, textStatus, request) {
                if (data !== 'false') {
                    var results  = $.parseJSON(data);
                    var template = $("#new-plugin-template");
                    $.each(results, function(i, item) {
                        $(".plugin-name", template).text(i);
                        $(".plugin-short-description", template).text(item.desc);
                        var newplugin = template.html();
                        $(".plugin-repo").prepend(newplugin);
                    });
                    $(document).trigger('pluginsUpdated');
                }
                destroyPage();
            });
            return false;
        });
        // Menu refresh after fresh plugin install.
        $("#menu-refresh").on("click", function () {
            var url = $(this).attr("href");
            $.get(url, {"via-ajax": "light+mods"}, function (data, textStatus, request) {
                var mainnav = $("#main-nav");
                mainnav.slideUp('slow');
                mainnav.html(data);
                mainnav.slideDown('slow');
            });
            return false;
        });
        // Plugin get info.
        $(".plugin-get-info").on("click", function() {
            var plugin        = $(this).data("plugin");
            var template      = $("#plugin-info");
            $.get(null, {"info" : "get", "plugin" : plugin}, function (data, textStatus, request) {
                var config = $.parseJSON(data);
                $("#plugin-modal-label", template).text(config.name + ' V ' + config['version']);
                $("#config-description", template).text(config.description);
                $("#config-founder", template).text(config.founder);
                $("#config-author", template).text(config.author);
                $("#config-email", template).text(config.email);
                $("#config-homepage", template).text(config.homepage);
                $("#config-date", template).text(config.date);
                $("#config-copyright", template).text(config.copyright);
                $("#config-license", template).text(config.license);
                $("#config-info", template).html(config.info);
                $.each(function() {

                });
                $('#plugin-info').modal();
            });
            return false;
        });
    });

    function bindNewPluginButtins (bind)
    {
        $(bind).hover(
            function() {
                $("div.hide", this).show();
            },
            function () {
                $("div.hide", this).hide();
            }
        );
    }
</script>